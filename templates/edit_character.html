{% extends "base.html" %}

{% block title %}Editar Personagem{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}">
    <h1>Editar Personagem</h1>
    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <!-- Nome do Personagem -->
                <div class="form-group">
                    <label for="name">Nome:</label>
                    <input type="text" id="name" name="name" class="form-control" value="{{ character['name'] }}" required>
                </div>

                <!-- Seleção de Raça -->
                <h2>1. Escolha sua Raça</h2>
                <div class="form-group">
                    <label for="race_id">Raça:</label>
                    <select id="race_id" name="race_id" class="form-control" onchange="atualizarImagemRaça()">
                        {% for race in races %}
                            <option value="{{ race._id }}"
                                data-nome="{{ race.name }}"
                                data-forca="{{ race.forca_bonus }}"
                                data-destreza="{{ race.destreza_bonus }}"
                                data-constituicao="{{ race.constituicao_bonus }}"
                                data-inteligencia="{{ race.inteligencia_bonus }}"
                                data-sabedoria="{{ race.sabedoria_bonus }}"
                                data-carisma="{{ race.carisma_bonus }}"
                                {% if race._id == character['race_id'] %}selected{% endif %}>
                                {{ race.name }} ({{ race.habilidades_inatas | join(', ') }})
                            </option>
                        {% endfor %}
                    </select>
                    <div id="atributos-raca-tooltip" class="tooltip-custom"></div>
                </div>

                <!-- Seleção de Classe -->
                <h2>2. Escolha sua Classe</h2>
                <div class="form-group">
                    <label for="class_id">Classe:</label>
                    <select id="class_id" name="class_id" class="form-control" onchange="atualizarImagemClasse()">
                        {% for class in classes %}
                            <option value="{{ class._id }}"
                                data-nome="{{ class.name }}"
                                data-forca="{{ class.forca }}"
                                data-destreza="{{ class.destreza }}"
                                data-constituicao="{{ class.constituicao }}"
                                data-inteligencia="{{ class.inteligencia }}"
                                data-sabedoria="{{ class.sabedoria }}"
                                data-carisma="{{ class.carisma }}"
                                {% if class._id == character['class_id'] %}selected{% endif %}>
                                {{ class.name }} ({{ class.habilidades_classe | join(', ') }})
                            </option>
                        {% endfor %}
                    </select>
                    <div id="atributos-classe-tooltip" class="tooltip-custom"></div>
                </div>

                <!-- Distribuição de Atributos -->
                <h2>3. Defina seus Atributos (Min 3 e max 18)</h2>
                <h1>Pontos restantes: <span id="pontosRestantes">30</span></h1>
                {% set atributos = ["forca", "destreza", "constituicao", "inteligencia", "sabedoria", "carisma"] %}
                {% for atributo in atributos %}
                <div class="form-group">
                    <label for="{{ atributo|lower }}">{{ atributo|capitalize }}:</label>
                    <div class="input-group">
                        <button type="button" class="btn btn-secondary" onclick="alterarValor('{{ atributo }}', -1)">-</button>
                        <input type="number" id="{{ atributo }}" name="{{ atributo }}" class="form-control atributo" min="3" max="18" value="{{ character[atributo] }}" required readonly>
                        <button type="button" class="btn btn-secondary" onclick="alterarValor('{{ atributo }}', 1)">+</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Exibir Imagem de Raça ou Classe à Direita -->
            <div class="col-md-6">
                <h2>Exemplo de Raça</h2>
                <div class="image-container">
                    <img id="selected-image" src="{{ url_for('static', filename='images/default.png') }}" alt="Imagem Selecionada" class="img-fluid fade-in">
                </div>
                <!-- Descrição da Raça -->
                <div class="race-description mt-3">
                    <h3>Descrição da Raça</h3>
                    <p id="race-description-text">{{ character['race_description'] if request.endpoint == 'edit_character_route' else '' }}</p>
                </div>
            </div>
        </div>

        <!-- Seleção de Perícias -->
        <h2>4. Escolha até 3 Perícias</h2>
        <div class="form-group">
            {% for pericia in pericias %}
                <div class="form-check">
                    <input class="form-check-input pericia-checkbox" type="checkbox" name="pericias" value="{{ pericia }}" id="pericia-{{ pericia | lower }}" {% if pericia in character['pericias'] %}checked{% endif %}>
                    <label class="form-check-label" for="pericia-{{ pericia | lower }}">{{ pericia }}</label>
                </div>
            {% endfor %}
        </div>

        <!-- Descrição da Origem -->
        <h2>5. Escolha sua Origem</h2>
        <div class="form-group">
            <label for="origem">Origem:</label>
            <textarea id="origem" name="origem" class="form-control" rows="4" placeholder="Descreva o histórico do personagem..." required>{{ character['origem'] }}</textarea>
        </div>

        <!-- Upload da Imagem -->
        <div class="form-group">
            <label for="img_url">Foto do Personagem:</label>
            <div class="mb-3">
                <img src="{{ url_for('static', filename=character['img_url']) }}" alt="{{ character['name'] }}" width="100" height="100">
            </div>
            <input type="file" id="img_url" name="img_url" class="form-control" accept="image/*">
            <small class="form-text text-muted">Escolha uma nova imagem para substituir a atual (opcional).</small>
        </div>

        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancelar</a>
    </form>

    <script>
        const maxPontos = 10;
        let pontosExtraHumano = 0; // Variável para armazenar os pontos extras do humano
        const pontosRestantesElem = document.getElementById('pontosRestantes');
        const atributos = document.querySelectorAll('.atributo');

        function atualizarPontosRestantes() {
            let total = 0;
            atributos.forEach(input => {
                total += parseInt(input.value);
            });
            const pontosRestantes = (maxPontos + pontosExtraHumano) - (total - (atributos.length * 10));

            if (isNaN(pontosRestantes)) {
                pontosRestantesElem.textContent = 'Erro';
            } else {
                pontosRestantesElem.textContent = pontosRestantes;
            }

            if (pontosRestantes < 0) {
                atributos.forEach(input => {
                    if (parseInt(input.value) > 10) {
                        input.value = parseInt(input.value) - 1;
                    }
                });
                atualizarPontosRestantes();
            }
        }

        function alterarValor(atributo, valor) {
            const input = document.getElementById(atributo);
            let atual = parseInt(input.value);
            const novoValor = atual + valor;

            // Verifica os limites
            if (novoValor >= 3 && novoValor <= 18) {
                input.value = novoValor;
                atualizarPontosRestantes();
            }
        }

        function atualizarImagemRaça() {
            const raceSelect = document.getElementById('race_id');
            const selectedRace = raceSelect.options[raceSelect.selectedIndex];
            const imageUrl = `/static/images/races/${selectedRace.getAttribute('data-nome').toLowerCase()}.png`;
            document.getElementById('selected-image').src = imageUrl;
            document.getElementById('selected-image').classList.add('fade-in');  // Adiciona a classe de animação

            // Atualiza a descrição da raça
            const raceDescription = selectedRace.getAttribute('data-resumo');
            document.getElementById('race-description-text').textContent = raceDescription;

            // Verifica se a raça é humano
            if (selectedRace.getAttribute('data-nome').toLowerCase() === 'humano') {
                pontosExtraHumano = 3;
            } else {
                pontosExtraHumano = 0;
            }

            atributos.forEach(input => {
                const bonus = parseInt(selectedRace.getAttribute(`data-${input.id}`)) || 0; // Certifique-se de que bonus seja um número válido
                input.value = 10 + bonus;
            });

            atualizarPontosRestantes();
        }

        function atualizarImagemClasse() {
            const classSelect = document.getElementById('class_id');
            const selectedClass = classSelect.options[classSelect.selectedIndex];
            const imageUrl = `/static/images/classes/${selectedClass.getAttribute('data-nome').toLowerCase()}.png`;
            document.getElementById('selected-image').src = imageUrl;

            atributos.forEach(input => {
                const baseValue = parseInt(selectedClass.getAttribute(`data-${input.id}`)) || 10; // Certifique-se de que baseValue seja um número válido
                input.value = baseValue;
            });

            atualizarPontosRestantes();
        }

        atributos.forEach(input => {
            input.addEventListener('input', atualizarPontosRestantes);
        });

        // Chama funções de atualização de imagens e pontos no carregamento inicial
        window.onload = function() {
            atualizarImagemRaça();
            atualizarImagemClasse();
            atualizarPontosRestantes();
        }

        // Limite de 3 perícias selecionadas
        const maxPericias = 3;
        const periciaCheckboxes = document.querySelectorAll('.pericia-checkbox');

        periciaCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCheckboxes = document.querySelectorAll('.pericia-checkbox:checked');
                if (checkedCheckboxes.length > maxPericias) {
                    this.checked = false;
                    alert('Você só pode selecionar até 3 perícias.');
                }
            });
        });
    </script>

    <style>
        .tooltip-custom {
            display: none;
            position: absolute;
            background-color: rgba(0, 0, 0, 1);
            border: 1px solid #ddd;
            padding: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .image-container {
            text-align: center;
        }

        .img-fluid {
            max-width: 100%;
            height: auto;
        }

        /* Animação para a imagem */
        .fade-in {
            opacity: 0;
            animation: fadeInAnimation 1s forwards;
        }

        @keyframes fadeInAnimation {
            to {
                opacity: 1;
            }
        }
    </style>
{% endblock %}
