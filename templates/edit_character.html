{% extends "base.html" %}

{% block title %}Editar Personagem{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}">
    <h1>Editar Personagem</h1>
    <form method="POST" enctype="multipart/form-data">
        
        <!-- Nome do Personagem -->
        <div class="form-group">
            <label for="name">Nome:</label>
            <input type="text" id="name" name="name" class="form-control" value="{{ character['name'] }}" required>
        </div>

        <!-- Distribuição de Atributos -->
        <h2>1. Defina seus Atributos (Min 3 e max 18)</h2>
        <p>Pontos restantes: <span id="pontosRestantes">30</span></p>
        <div class="form-group">
            <label for="forca">Força:</label>
            <input type="number" id="forca" name="forca" class="form-control atributo" min="3" max="18" value="{{ character['forca'] }}" required>
        </div>
        <div class="form-group">
            <label for="destreza">Destreza:</label>
            <input type="number" id="destreza" name="destreza" class="form-control atributo" min="3" max="18" value="{{ character['destreza'] }}" required>
        </div>
        <div class="form-group">
            <label for="constituicao">Constituição:</label>
            <input type="number" id="constituicao" name="constituicao" class="form-control atributo" min="3" max="18" value="{{ character['constituicao'] }}" required>
        </div>
        <div class="form-group">
            <label for="inteligencia">Inteligência:</label>
            <input type="number" id="inteligencia" name="inteligencia" class="form-control atributo" min="3" max="18" value="{{ character['inteligencia'] }}" required>
        </div>
        <div class="form-group">
            <label for="sabedoria">Sabedoria:</label>
            <input type="number" id="sabedoria" name="sabedoria" class="form-control atributo" min="3" max="18" value="{{ character['sabedoria'] }}" required>
        </div>
        <div class="form-group">
            <label for="carisma">Carisma:</label>
            <input type="number" id="carisma" name="carisma" class="form-control atributo" min="3" max="18" value="{{ character['carisma'] }}" required>
        </div>

        <div class="form-group">
            <label for="reflexo">Reflexo:</label>
            <input type="number" id="reflexo" name="reflexo" class="form-control" value="{{ character['reflexo'] }}" required>
        </div>
        <div class="form-group">
            <label for="fortitude">Fortitude:</label>
            <input type="number" id="fortitude" name="fortitude" class="form-control" value="{{ character['fortitude'] }}" required>
        </div>
        <div class="form-group">
            <label for="vontade">Vontade:</label>
            <input type="number" id="vontade" name="vontade" class="form-control" value="{{ character['vontade'] }}" required>
        </div>

        <!-- Seleção de Raça -->
        <h2>2. Escolha sua Raça</h2>
        <div class="form-group">
            <label for="race_id">Raça:</label>
            <select id="race_id" name="race_id" class="form-control">
                {% for race in races %}
                    <option value="{{ race._id }}" {% if race._id == character['race_id'] %}selected{% endif %}>
                        {{ race.name }} ({{ race.habilidades_inatas | join(', ') }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Seleção de Classe -->
        <h2>3. Escolha sua Classe</h2>
        <div class="form-group">
            <label for="class_id">Classe:</label>
            <select id="class_id" name="class_id" class="form-control">
                {% for class in classes %}
                    <option value="{{ class._id }}" {% if class._id == character['class_id'] %}selected{% endif %}>
                        {{ class.name }} ({{ class.habilidades_classe | join(', ') }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Seleção de Perícias -->
        <h2>4. Escolha até 3 Perícias</h2>
        <div class="form-group">
            {% for pericia in pericias %}
                <div class="form-check">
                    <input class="form-check-input pericia-checkbox" type="checkbox" name="pericias" value="{{ pericia }}" id="pericia-{{ pericia | lower }}" {% if pericia in character['pericias'] %}checked{% endif %}>
                    <label class="form-check-label" for="pericia-{{ pericia | lower }}">{{ pericia }}</label>
                </div>
            {% endfor %}
        </div>

        <!-- Descrição da Origem -->
        <h2>5. Escolha sua Origem</h2>
        <div class="form-group">
            <label for="origem">Origem:</label>
            <textarea id="origem" name="origem" class="form-control" rows="4" placeholder="Descreva o histórico do personagem..." required>{{ character['origem'] }}</textarea>
        </div>

        <!-- Upload da Imagem -->
        <div class="form-group">
            <label for="img_url">Foto do Personagem:</label>
            <div class="mb-3">
                <img src="{{ url_for('static', filename=character['img_url']) }}" alt="{{ character['name'] }}" width="100" height="100">
            </div>
            <input type="file" id="img_url" name="img_url" class="form-control" accept="image/*">
            <small class="form-text text-muted">Escolha uma nova imagem para substituir a atual (opcional).</small>
        </div>

        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancelar</a>
    </form>

    <script>
        const maxPontos = 30;
        const pontosRestantesElem = document.getElementById('pontosRestantes');
        const atributos = document.querySelectorAll('.atributo');

        function atualizarPontosRestantes() {
            let total = 0;
            atributos.forEach(input => {
                total += parseInt(input.value);
            });
            const pontosRestantes = maxPontos - (total - (atributos.length * 10)); // (total - valor inicial)
            pontosRestantesElem.textContent = pontosRestantes;

            // Impedir que o valor dos atributos ultrapasse o limite total de pontos
            if (pontosRestantes < 0) {
                atributos.forEach(input => {
                    if (parseInt(input.value) > 10) {
                        input.value = parseInt(input.value) - 1;
                    }
                });
                atualizarPontosRestantes();
            }
        }

        atributos.forEach(input => {
            input.addEventListener('input', atualizarPontosRestantes);
        });

        atualizarPontosRestantes(); // Inicializa o contador

        // Limite de 3 perícias selecionadas
        const maxPericias = 3;
        const periciaCheckboxes = document.querySelectorAll('.pericia-checkbox');

        periciaCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCheckboxes = document.querySelectorAll('.pericia-checkbox:checked');
                if (checkedCheckboxes.length > maxPericias) {
                    this.checked = false;
                    alert('Você só pode selecionar até 3 perícias.');
                }
            });
        });
    </script>
{% endblock %}
